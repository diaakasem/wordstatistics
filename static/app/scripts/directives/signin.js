// Generated by CoffeeScript 1.7.1
(function() {
  "use strict";
  var controller;

  controller = function(root, scope, fb) {
    scope.model = {};
    Parse.FacebookUtils.init(fb.fbParams);
    scope.signinFacebook = function() {
      return Parse.FacebookUtils.logIn(null, {
        success: function(user) {
          if (!user.existed()) {
            return alert("User signed up and logged in through Facebook!");
          } else {
            return alert("User logged in through Facebook!");
          }
        },
        error: function(user, error) {
          return alert("User cancelled the Facebook login or did not fully authorize.");
        }
      });
    };
    return scope.signin = function(form) {
      if (form.$invalid) {
        return;
      }
      return Parse.User.logIn(scope.model.email, scope.model.password, {
        success: function(user) {
          var query, roleSuccess;
          root.user = user;
          roleSuccess = function(role) {
            var adminRelation, queryAdmins;
            adminRelation = new Parse.Relation(role, "users");
            queryAdmins = adminRelation.query();
            queryAdmins.equalTo("objectId", root.user.id);
            return queryAdmins.first({
              success: function(result) {
                root.isAdmin = result;
                if (root.isAdmin) {
                  return root.go('/');
                } else {
                  return root.go('/');
                }
              }
            });
          };
          query = new Parse.Query(Parse.Role);
          query.equalTo("name", "Administrator");
          return query.first({
            success: roleSuccess
          });
        },
        error: function(user, error) {
          console.log(error);
          return alert("Invalid username or password. Please try again.");
        }
      });
    };
  };

  angular.module("wordsApp").directive("signin", function() {
    return {
      templateUrl: 'views/directives/signin.html',
      restrict: "E",
      replace: true,
      scope: true,
      controller: ['$rootScope', '$scope', '$FB', controller]
    };
  });

}).call(this);
