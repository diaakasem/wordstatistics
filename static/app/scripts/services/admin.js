// Generated by CoffeeScript 1.7.1
(function() {
  'use strict';
  var Admin;

  Admin = (function() {
    function Admin(Pubsub) {
      var query;
      this.Pubsub = Pubsub;
      this.events = {
        UPDATED: 'Users updated'
      };
      this.Pubsub.engage(this, this.events);
      query = new Parse.Query(Parse.Role);
      query.equalTo("name", "Administrator");
      query.first({
        success: (function(_this) {
          return function(adminRole) {
            _this.adminRole = adminRole;
            return _this.updateUsers();
          };
        })(this)
      });
    }

    Admin.prototype.updateUsers = function() {
      var usersQuery;
      this.users = this.adminRole.getUsers();
      usersQuery = this.users.query();
      return usersQuery.find({
        success: (function(_this) {
          return function(roleUsers) {
            _this.roleUsers = roleUsers;
            return _this.notify(_this.events.UPDATE, _this.roleUsers);
          };
        })(this)
      });
    };

    Admin.prototype.isAdmin = function(user) {
      if (this.roleUsers) {
        return _.find(this.roleUsers, function(roleUser) {
          return roleUser.id === user.id;
        });
      }
    };

    Admin.prototype.switchAdmin = function(user, cb, errCB) {
      var index, isAdmin, roleACL;
      isAdmin = this.isAdmin(user);
      roleACL = this.adminRole.getACL();
      roleACL.setReadAccess(user, !isAdmin);
      roleACL.setWriteAccess(user, !isAdmin);
      if (!isAdmin) {
        this.adminRole.getUsers().add(user);
      } else {
        this.adminRole.getUsers().remove(user);
        index = _.findIndex(this.roleUsers, function(roleUser) {
          return roleUser.id === user.id;
        });
      }
      return this.adminRole.save({
        success: (function(_this) {
          return function(obj) {
            _this.updateUsers();
            return typeof cb === "function" ? cb(obj) : void 0;
          };
        })(this),
        error: (function(_this) {
          return function(obj, err) {
            return typeof errCB === "function" ? errCB(obj, err) : void 0;
          };
        })(this)
      });
    };

    return Admin;

  })();

  angular.module('wordsApp').service('Admin', ['Pubsub', Admin]);

}).call(this);
